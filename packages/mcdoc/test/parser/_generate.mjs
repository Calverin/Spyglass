import fs from 'fs'
import path from 'path'
import url from 'url'
import { McdocParserTestSuites } from './_suites.mjs'

// Generates test files for each mcdoc rule parser with test suites from `./suites.mts`.
// It is super laggy to have a giant snapshot file, hence why we separated the tests to multiple files.

const ShouldGenerate = false // Prevent from mis-triggering.

/**
 * @param {string} parser
 * @param {string} directory
 * @returns {string}
 */
function template(parser, directory, functionParams = '') {
	return `// This file is generated by \`_generate.mts\`. Do not modify by hand.
import { showWhitespaceGlyph, testParser } from '@spyglassmc/core/test-out/utils.mjs'
import { describe, it } from 'mocha'
import snapshot from 'snap-shot-it'
import { ${parser} } from '@spyglassmc/mcdoc/lib/parser/index.mjs'
// @ts-ignore
import { McdocParserTestSuites } from '@spyglassmc/mcdoc/test/parser/_suites.mjs'

describe('mcdoc ${parser}${functionParams ? '()' : ''}', () => {
	for (const content of McdocParserTestSuites['${directory}'].${parser}.content) {
		it(\`Parse "\${showWhitespaceGlyph(content)}"\`, () => {
			snapshot(testParser(${parser}${functionParams}, content))
		})
	}
})
`
}

if (ShouldGenerate) {
	for (const [directory, parserSuites] of Object.entries(McdocParserTestSuites)) {
		for (const [parser, { functionParams }] of Object.entries(parserSuites)) {
			fs.writeFileSync(
				path.join(url.fileURLToPath(new URL('.', import.meta.url)), directory, `${parser}.generated.spec.mts`),
				template(parser, directory, functionParams),
				{ encoding: 'utf-8' }
			)
		}
	}
}
